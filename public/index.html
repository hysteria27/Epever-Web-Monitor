<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <!-- FIREBASE SDK (App, Database, Storage, Auth) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <script src="fbConfig.js"> // --- FIREBASE CONFIG --- </script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { solar: { 50: '#f0fdf4', 100: '#dcfce7', 500: '#008744', 600: '#16a34a' }, slate: { 850: '#152033', 900: '#0f172a', 950: '#020617' } }
                }
            }
        }
    </script>
    <style>
        :root { --transition-speed: 0.3s; }
        body { transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease; }
        .hidden-view { display: none !important; }
        .gauge-ring { transform: rotate(-90deg); transform-origin: 50% 50%; transition: stroke-dashoffset 1s, stroke 0.5s; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #334155; }
        input[type=number] { -moz-appearance: textfield; }
        /* Tooltip cursor */
        .has-tooltip { cursor: help; }
        /* Disabled Input */
        input:disabled, select:disabled { background-color: #e2e8f0; color: #94a3b8; cursor: not-allowed; }
        .dark input:disabled, .dark select:disabled { background-color: #334155; color: #64748b; }
    </style>
</head>
<body class="bg-gray-50 dark:bg-slate-950 text-gray-800 dark:text-gray-100 min-h-screen flex flex-col">
    <!-- LOGIN SCREEN -->
    <div id="view-login" class="flex-grow flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 p-8 rounded-2xl shadow-xl border border-gray-100 dark:border-slate-800 w-full max-w-md">
            <div class="text-center mb-8">
                <i data-lucide="zap" class="w-12 h-12 text-solar-500 mx-auto mb-2"></i>
                <h1 class="text-2xl font-bold">EPEVER Monitor</h1>
                <p class="text-gray-500 text-sm">Please sign in to continue</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">EMAIL</label>
                    <input type="email" id="login-email" class="w-full p-3 rounded-lg bg-gray-50 dark:bg-slate-800 border border-gray-200 dark:border-slate-700 focus:ring-2 focus:ring-solar-500 outline-none transition-all">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">PASSWORD</label>
                    <input type="password" id="login-pass" class="w-full p-3 rounded-lg bg-gray-50 dark:bg-slate-800 border border-gray-200 dark:border-slate-700 focus:ring-2 focus:ring-solar-500 outline-none transition-all">
                </div>
                <button onclick="doLogin()" class="w-full bg-solar-600 hover:bg-solar-700 text-white font-bold py-3 rounded-lg transition-colors flex justify-center gap-2">
                    <span id="login-btn-text">Sign In</span>
                </button>
                <p id="login-error" class="text-center text-red-500 text-xs mt-2 hidden"></p>
            </div>
        </div>
    </div>

    <!-- MAIN APP CONTENT -->
    <div id="view-app" class="hidden-view flex-col min-h-screen">
        <div class="max-w-7xl mx-auto w-full p-4 md:p-6 lg:p-8">
            <!-- Header -->
            <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                <div>
                    <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight flex items-center gap-2">
                        <i data-lucide="zap" class="text-solar-500 w-8 h-8"></i>Solar Monitor
                    </h1>
                    <p class="text-gray-500 dark:text-gray-400 text-sm mt-1 flex items-center gap-2">
                        <span id="conn-dot" class="inline-block w-2 h-2 rounded-full bg-red-500"></span>
                        <span id="connection-status">Firebase Connecting...</span>
                        
                        <span id="conn-dot-device" class="inline-block w-2 h-2 rounded-full bg-red-500"></span>
                        <span id="device-status">Modbus Connecting...</span>
                    </p>
                </div>
                <div class="flex bg-white dark:bg-slate-900 p-1 rounded-lg border border-gray-200 dark:border-slate-800 shadow-sm flex-wrap gap-1">
                    <button onclick="switchView('dashboard')" id="btn-dashboard" class="px-4 py-2 rounded-md text-sm font-medium flex gap-2 items-center transition-all bg-solar-500 text-white shadow-md"><i data-lucide="layout-dashboard" class="w-4 h-4"></i> Live</button>
                    <button onclick="switchView('history')" id="btn-history" class="px-4 py-2 rounded-md text-sm font-medium flex gap-2 items-center text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-slate-800 transition-all"><i data-lucide="calendar-clock" class="w-4 h-4"></i> Log</button>
                    <button onclick="switchView('firmware')" id="btn-firmware" class="px-4 py-2 rounded-md text-sm font-medium flex gap-2 items-center text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-slate-800 transition-all"><i data-lucide="package" class="w-4 h-4"></i> OTA</button>
                </div>
                <button onclick="doLogout()" class="p-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg" title="Logout"><i data-lucide="log-out" class="w-5 h-5"></i></button>
            </header>

            <!-- DASHBOARD VIEW -->
            <div id="view-dashboard" class="fade-in space-y-6">
                <!-- KPI Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="bg-white dark:bg-slate-900 border border-gray-100 dark:border-slate-800 p-5 rounded-xl shadow-sm has-tooltip" title="Current charging stage (MPPT, Float, Boost, etc.)"><div><p class="text-xs font-bold text-gray-400 uppercase">Status</p><h3 id="charging-stage-display" class="text-lg font-bold mt-1">Standby</h3></div></div>
                    <div class="bg-white dark:bg-slate-900 border border-gray-100 dark:border-slate-800 p-5 rounded-xl shadow-sm has-tooltip" title="Real-time power generated by solar panels"><div><p class="text-xs font-bold text-gray-400 uppercase">PV Power</p><h3 id="panel-power" class="text-2xl font-black">0</h3><span class="text-sm text-gray-500">W</span></div><div class="w-full bg-gray-100 dark:bg-slate-800 h-1.5 rounded-full mt-3 overflow-hidden"><div id="pv-bar" class="bg-orange-500 h-full" style="width: 0%"></div></div></div>
                    <div class="bg-white dark:bg-slate-900 border border-gray-100 dark:border-slate-800 p-5 rounded-xl shadow-sm has-tooltip" title="Current battery bank voltage"><div><p class="text-xs font-bold text-gray-400 uppercase">Battery</p><h3 id="battery-voltage" class="text-2xl font-black">0.0</h3><span class="text-sm text-gray-500">V</span></div></div>
                    <div class="bg-white dark:bg-slate-900 border border-gray-100 dark:border-slate-800 p-5 rounded-xl shadow-sm has-tooltip" title="Power consumed by DC load output"><div><p class="text-xs font-bold text-gray-400 uppercase">DC Load</p><h3 id="load-power" class="text-2xl font-black">0</h3><span class="text-sm text-gray-500">W</span></div></div>
                </div>
                
                <!-- Charts & SOC -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="bg-white dark:bg-slate-900 border border-gray-100 dark:border-slate-800 p-6 rounded-xl shadow-sm flex flex-col items-center justify-center has-tooltip" title="Estimated Battery State of Charge"><h3 class="text-sm font-bold text-gray-500 mb-4">SOC</h3><div class="w-48 h-48 relative"><svg class="w-full h-full" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="none" stroke="currentColor" stroke-width="8" class="text-gray-100 dark:text-slate-800"></circle><circle id="gauge-ring" cx="50" cy="50" r="45" fill="none" stroke="#eab308" stroke-width="8" stroke-dasharray="282.7" stroke-dashoffset="282.7" class="gauge-ring"></circle></svg><div class="absolute inset-0 flex flex-col items-center justify-center"><span id="gauge-soc-text" class="text-4xl font-black">0%</span></div></div></div>
                    <div class="lg:col-span-2 bg-white dark:bg-slate-900 border border-gray-100 dark:border-slate-800 p-6 rounded-xl shadow-sm"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-lg">Live Flow</h3><span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">Live</span></div><div class="h-64 w-full"><canvas id="liveChart"></canvas></div></div>
                </div>

                <!-- Telemetry -->
                <div class="bg-white dark:bg-slate-900 border border-gray-100 dark:border-slate-800 p-6 rounded-2xl shadow-sm">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-lg text-gray-800 dark:text-gray-100">Live Telemetry</h3>
                        <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded dark:bg-blue-900 dark:text-blue-300">Modbus RTU</span>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="p-4 bg-gray-50 dark:bg-slate-800/50 rounded-xl border border-gray-100 dark:border-slate-700/50 has-tooltip" title="Voltage from PV Array"><p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Panel Voltage</p><p class="text-2xl font-bold text-gray-800 dark:text-white"><span id="detail-pv-volt">0.0</span> <span class="text-sm font-normal text-gray-500">V</span></p></div>
                        <div class="p-4 bg-gray-50 dark:bg-slate-800/50 rounded-xl border border-gray-100 dark:border-slate-700/50 has-tooltip" title="Current flowing into battery"><p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Charge Current</p><p class="text-2xl font-bold text-gray-800 dark:text-white"><span id="detail-chg-amp">0.0</span> <span class="text-sm font-normal text-gray-500">A</span></p></div>
                        <div class="p-4 bg-gray-50 dark:bg-slate-800/50 rounded-xl border border-gray-100 dark:border-slate-700/50 has-tooltip" title="Internal Controller Temperature"><p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Device Temp</p><p class="text-2xl font-bold text-gray-800 dark:text-white"><span id="detail-temp">0.0</span> <span class="text-sm font-normal text-gray-500">°C</span></p></div>
                        <div class="p-4 bg-gray-50 dark:bg-slate-800/50 rounded-xl border border-gray-100 dark:border-slate-700/50 has-tooltip" title="Total Energy generated Today"><p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Daily Energy</p><p class="text-2xl font-bold text-green-600 dark:text-green-400"><span id="detail-daily-energy">0.00</span> <span class="text-sm font-normal text-gray-500">kWh</span></p></div>
                    </div>
                </div>
            </div>

            <!-- HISTORY VIEW -->
            <div id="view-history" class="hidden-view fade-in space-y-6">
                <div class="flex flex-col md:flex-row justify-between items-center bg-white dark:bg-slate-900 p-4 rounded-2xl border border-gray-100 dark:border-slate-800 shadow-sm gap-4">
                    <div><h2 class="text-xl font-bold">History Log</h2><p class="text-gray-500 text-xs">Select date to view logs.</p></div>
                    <div class="flex gap-2 items-center">
                        <input type="date" id="logDateSelector" class="bg-gray-50 dark:bg-slate-800 border border-gray-200 dark:border-slate-700 text-gray-900 dark:text-white text-sm rounded-lg block p-2.5">
                        <button onclick="fetchDayLog()" class="bg-solar-500 hover:bg-solar-600 text-white font-medium rounded-lg text-sm px-4 py-2.5" title="Load data for selected date"><i data-lucide="search" class="w-4 h-4"></i></button>
                        <button onclick="downloadLog()" class="bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 hover:bg-gray-50 dark:hover:bg-slate-700 text-gray-700 dark:text-gray-200 font-medium rounded-lg text-sm px-4 py-2.5 flex items-center gap-2" title="Download CSV file"><i data-lucide="download" class="w-4 h-4"></i> <span class="hidden md:inline">CSV</span></button>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-slate-900 border border-gray-100 dark:border-slate-800 p-6 rounded-2xl shadow-sm">
                    <h3 class="font-bold text-lg mb-4">Intraday PV Power (Watts)</h3>
                    <div class="h-72 w-full relative"><canvas id="dayChart"></canvas><div id="no-data-msg" class="absolute inset-0 flex items-center justify-center text-gray-400 hidden">No data</div></div>
                </div>
                
                <div class="bg-white dark:bg-slate-900 border border-gray-100 dark:border-slate-800 rounded-2xl shadow-sm overflow-hidden">
                    <div class="p-6 border-b border-gray-100 dark:border-slate-800"><h3 class="font-bold text-lg">Detailed Log <span id="detail-date-title" class="text-sm font-normal text-gray-500 ml-2"></span></h3></div>
                    <div class="max-h-64 overflow-y-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-50 dark:bg-slate-800/50 text-gray-500 uppercase text-xs sticky top-0">
                                <tr><th class="px-6 py-3">Time</th><th class="px-6 py-3">Status</th><th class="px-6 py-3 text-right">Power</th><th class="px-6 py-3 text-right">Bat</th><th class="px-6 py-3 text-right">SOC</th></tr>
                            </thead>
                            <tbody id="detail-table-body" class="divide-y divide-gray-100 dark:divide-slate-800"><tr><td colspan="5" class="p-4 text-center text-gray-400">Select date</td></tr></tbody>
                        </table>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-slate-900 border border-gray-100 dark:border-slate-800 rounded-2xl shadow-sm overflow-hidden">
                    <div class="p-6 border-b border-gray-100 dark:border-slate-800 flex justify-between items-center"><h3 class="font-bold text-lg">Monthly Summary</h3><button onclick="fetchSummary()" class="text-sm text-solar-500 font-bold" title="Reload summary list">Refresh</button></div>
                    <div class="max-h-64 overflow-y-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-50 dark:bg-slate-800/50 text-gray-500 uppercase text-xs sticky top-0"><tr><th class="px-6 py-3">Date</th><th class="px-6 py-3 text-right">Yield (kWh)</th></tr></thead>
                            <tbody id="summary-table-body" class="divide-y divide-gray-100 dark:divide-slate-800"><tr><td colspan="2" class="p-4 text-center text-gray-400">Loading...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- FIRMWARE VIEW -->
            <div id="view-firmware" class="hidden-view fade-in space-y-6">
                <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl border border-gray-100 dark:border-slate-800 shadow-sm">
                    <div class="flex justify-between items-center mb-6">
                        <div><h2 class="text-xl font-bold">Firmware Update</h2><p class="text-gray-500 text-sm">Update device firmware over-the-air (OTA).</p></div>
                        <button onclick="fetchFirmwareInfo()" class="text-sm text-solar-500 font-bold flex gap-1 items-center" title="Refresh firmware info"><i data-lucide="refresh-cw" class="w-4 h-4"></i> Refresh</button>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Current Firmware Info -->
                        <div class="space-y-4">
                            <h3 class="font-bold text-gray-400 text-xs uppercase tracking-wider border-b pb-2">System Information</h3>
                            <div class="space-y-3 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Firmware Version:</span>
                                    <span id="fw-version" class="font-semibold">--</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Build Date:</span>
                                    <span id="fw-date" class="font-semibold">--</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Chip Model:</span>
                                    <span id="fw-chip" class="font-semibold text-xs">--</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Free Flash Space:</span>
                                    <span id="fw-free" class="font-semibold text-xs">--</span>
                                </div>
                            </div>
                        </div>

                        <!-- OTA Upload -->
                        <div class="lg:col-span-2 space-y-4">
                            <h3 class="font-bold text-gray-400 text-xs uppercase tracking-wider border-b pb-2">Upload New Firmware</h3>
                            <div class="p-4 bg-blue-50 dark:bg-blue-950 border border-blue-200 dark:border-blue-800 rounded-lg text-xs text-blue-700 dark:text-blue-300">
                                <p><strong>Instructions:</strong></p>
                                <ol class="list-decimal list-inside mt-2 space-y-1">
                                    <li>Build the project in Arduino IDE</li>
                                    <li>Locate the compiled <code>.bin</code> file (Sketch → Export compiled Binary)</li>
                                    <li>Select the file below and upload</li>
                                    <li>Device will restart automatically after update</li>
                                </ol>
                            </div>

                            <div class="border-2 border-dashed border-gray-300 dark:border-slate-700 rounded-lg p-6 text-center hover:bg-gray-50 dark:hover:bg-slate-800 transition-colors cursor-pointer" id="upload-dropzone">
                                <i data-lucide="cloud-upload" class="w-8 h-8 mx-auto text-gray-400 mb-2"></i>
                                <p class="text-sm font-semibold mb-1">Drag and drop .bin file</p>
                                <p class="text-xs text-gray-500">or click to browse</p>
                                <input type="file" id="fw-file-input" accept=".bin" class="hidden" onchange="handleFileSelect(event)">
                            </div>

                            <div id="fw-upload-status" class="p-3 bg-gray-50 dark:bg-slate-800 rounded-lg text-sm hidden">
                                <div class="flex justify-between mb-2">
                                    <span>Status:</span>
                                    <span id="fw-status-text">Uploading...</span>
                                </div>
                                <div class="w-full bg-gray-200 dark:bg-slate-700 h-2 rounded-full overflow-hidden">
                                    <div id="fw-progress-bar" class="bg-solar-500 h-full" style="width: 0%"></div>
                                </div>
                            </div>

                            <button id="fw-upload-btn" onclick="uploadFirmware()" class="w-full text-white bg-solar-600 hover:bg-solar-700 font-bold rounded-lg text-sm px-4 py-3 flex justify-center items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i data-lucide="upload-cloud" class="w-4 h-4"></i> Upload Firmware
                            </button>
                            <p id="fw-message" class="text-xs text-center text-gray-500"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
<script>
    /*
    document.getElementById('upload-dropzone')?.addEventListener('drop', (e) => {
        e.preventDefault();
        e.stopPropagation();
        e.currentTarget.classList.remove('bg-gray-100', 'dark:bg-slate-800');
        if (e.dataTransfer.files.length > 0) {
            const file = e.dataTransfer.files[0];
            if (file.name.endsWith('.bin')) {
                selectedFile = file;
                document.getElementById('fw-message').textContent = `Selected: ${file.name}`;
                document.getElementById('fw-message').className = 'text-xs text-center text-green-600 dark:text-green-400';
            } else {
                document.getElementById('fw-message').textContent = 'Please drop a .bin file';
                document.getElementById('fw-message').className = 'text-xs text-center text-red-600';
            }
        }
    });*/

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const storage = firebase.storage();
    const auth = firebase.auth();

    let isAuthenticated = false;    // User authentication state
    let isConnectionActive = false; // Prevents double-starting listeners
    let idleTimer = null;           // Holds the countdown
    const IDLE_TIMEOUT = 60000;     // 1 minute in milliseconds

    const activityEvents = ['mousedown', 'mousemove', 'keydown', 'scroll', 'touchstart'];   // Events that count as "Activity"
    activityEvents.forEach(event => {
        document.addEventListener(event, resetIdleTimer, { passive: true });                // Attach activity listeners
    });
    // resetIdleTimer();   // Start on load

    let liveChartInstance = null;
    let dayChartInstance = null;
    let livePVData = Array(30).fill(0);
    let liveLabels = Array(30).fill('');
    let fetchedLogData = [];

    window.addEventListener('load', () => {
        lucide.createIcons();
        initCharts();
        // auth.signInAnonymously().catch(console.error);
        // startFirebaseListener();
        
        document.getElementById('logDateSelector').valueAsDate = new Date(); // Set to today by default
        
        // Setup Drag & Drop
        const dropzone = document.getElementById('upload-dropzone');
        dropzone.addEventListener('click', () => document.getElementById('fw-file-input').click());
        dropzone.addEventListener('dragover', (e) => { e.preventDefault(); e.currentTarget.classList.add('bg-gray-100'); });
        dropzone.addEventListener('dragleave', (e) => { e.currentTarget.classList.remove('bg-gray-100'); });
        dropzone.addEventListener('drop', handleDrop);
    });

    // --- AUTH LOGIC ---
    auth.onAuthStateChanged((user) => {
        if (user) {
            // User Login -> Masuk Dashboard
            document.getElementById('view-login').classList.add('hidden-view');
            document.getElementById('view-app').classList.remove('hidden-view');
            document.getElementById('view-app').classList.add('flex');
            startFirebaseListener();
            isAuthenticated = true;
        } else {
            // User Logout -> Balik ke Login
            document.getElementById('view-login').classList.remove('hidden-view');
            document.getElementById('view-app').classList.add('hidden-view');
            document.getElementById('view-app').classList.remove('flex');
            document.getElementById('login-btn-text').textContent = "Sign In";
            stopFirebaseListener();
        }
    });

    function doLogin() {
        const email = document.getElementById('login-email').value;
        const pass = document.getElementById('login-pass').value;

        if (!email || !pass) {
            alert("Email dan Password tidak boleh kosong");
            return;
        }

        const btn = document.getElementById('login-btn-text');
        const err = document.getElementById('login-error');
        
        btn.textContent = "Signing In...";
        err.classList.add('hidden');

        auth.signInWithEmailAndPassword(email, pass)
            .catch((error) => {
                btn.textContent = "Sign In";
                err.textContent = "Invalid Login: " + error.message;
                err.classList.remove('hidden');
            });
    }

    function doLogout() {
        auth.signOut();
        isAuthenticated = false;
    }

    // --- IDLE & VISIBILITY LOGIC ---
    function resetIdleTimer() {
        if (!isAuthenticated) return; // No need to track if not logged in

        // 1. Clear existing timer
        if (idleTimer) clearTimeout(idleTimer);

        // 2. If we were paused/stopped and the tab is visible, wake up!
        if (!isConnectionActive && !document.hidden) {
            startFirebaseListener();
        }

        // 3. Set new timer: If no activity for 60s, Stop.
        idleTimer = setTimeout(() => {
            if (!document.hidden) { // Only log if we are looking at it
                console.log("User inactive for 1 min. Disconnecting.");
            }
            stopFirebaseListener();
        }, IDLE_TIMEOUT);
    }

    // Handle Tab Switching / Minimize
    /* document.addEventListener("visibilitychange", () => {
        if (document.hidden && isAuthenticated) {
            // Immediately kill connection when tab is hidden
            stopFirebaseListener(); 
        } else if (!document.hidden && isAuthenticated) {
            // Immediately restore connection when tab comes back
            startFirebaseListener();
            resetIdleTimer();
        } else {
            // Tab is visible but not authenticated
            stopFirebaseListener();
        }
    }); */
    
    // Safety net: Ensures disconnection if the user closes the window/tab directly
    window.addEventListener("pagehide", () => {
        if (isAuthenticated) {
            stopFirebaseListener();
        }
    });

    function switchView(id) {
        document.getElementById('view-dashboard').className = id==='dashboard'?'fade-in space-y-6':'hidden-view';
        document.getElementById('view-history').className = id==='history'?'fade-in space-y-6':'hidden-view';
        document.getElementById('view-firmware').className = id==='firmware'?'fade-in space-y-6':'hidden-view';
        
        // Update Buttons
        const activeClass = "bg-solar-500 text-white shadow-md";
        const inactiveClass = "text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-slate-800";

        if(id==='history') fetchDayLog(); // Auto fetch log when switched to history view
        if(id==='firmware') fetchFirmwareInfo(); // Auto fetch firmware info when switched to firmware view
        
        document.getElementById('btn-dashboard').className = `px-4 py-2 rounded-md text-sm font-medium transition-all flex gap-2 items-center ${id==='dashboard'?activeClass:inactiveClass}`;
        document.getElementById('btn-history').className = `px-4 py-2 rounded-md text-sm font-medium transition-all flex gap-2 items-center ${id==='history'?activeClass:inactiveClass}`;
        document.getElementById('btn-firmware').className = `px-4 py-2 rounded-md text-sm font-medium transition-all flex gap-2 items-center ${id==='firmware'?activeClass:inactiveClass}`;
    }

    function startFirebaseListener() {
        // Prevent double connections
        if (isConnectionActive) return;

        console.log("Starting Connection...");
        firebase.database().goOnline(); // Ensure socket is open

        const devStatus = document.getElementById('device-status');
        const devDot = document.getElementById('conn-dot-device');
        const statusEl = document.getElementById('connection-status');
        const dotEl = document.getElementById('conn-dot');

        // --- TAMBAHAN LISTENER STATUS PERANGKAT ---
        db.ref('epever/is_online').on('value', (snapshot) => {
            const isDeviceOnline = snapshot.val(); // true atau false
            
            // Update UI Dot Indikator Utama
            if (isDeviceOnline === true) {
                devStatus.textContent = "Device Online";
                devStatus.className = "text-sm text-green-600 font-bold";
                devDot.className = "inline-block w-2 h-2 rounded-full bg-green-500 animate-pulse";
            } else {
                devStatus.textContent = "Device Offline";
                devStatus.className = "text-sm text-red-600 font-bold";
                devDot.className = "inline-block w-2 h-2 rounded-full bg-red-500 animate-pulse";
            }
        });
        // --- AKHIR TAMBAHAN ---
        
        db.ref('epever/live').on('value', (snapshot) => {
            const data = snapshot.val();
            if (!data) return;

            // Update UI only if we are actually connected
            statusEl.textContent = "Firebase Connected";
            dotEl.className = "inline-block w-2 h-2 rounded-full bg-solar-500 animate-pulse";
            updateUI(data);
        });
        isConnectionActive = true;
    }

    function stopFirebaseListener() {
        if (!isConnectionActive) return;

        console.log("Stopping Connection (Idle/Background)...");

        // 1. Remove listeners to stop callbacks
        db.ref('epever/live').off();

        // 2. Kill the WebSocket to save bandwidth/battery immediately
        firebase.database().goOffline();

        const statusEl = document.getElementById('connection-status');
        const dotEl = document.getElementById('conn-dot');
        statusEl.textContent = "Paused (Idle)"; 
        dotEl.className = "inline-block w-2 h-2 rounded-full bg-yellow-500";

        isConnectionActive = false;
    }

    function updateUI(data) {
        const statusLabel = getStatusLabel(data.status_code);
        const statusEl = document.getElementById('charging-stage-display');
        statusEl.textContent = statusLabel.text;
        statusEl.className = `text-lg font-bold mt-1 ${statusLabel.color}`;

        document.getElementById('panel-power').textContent = Math.floor(data.pv.power);
        document.getElementById('pv-bar').style.width = Math.min((data.pv.power/500)*100, 100) + "%";
        document.getElementById('battery-voltage').textContent = data.batt.volt.toFixed(2);
        document.getElementById('load-power').textContent = Math.floor(data.load.power);
        document.getElementById('gauge-soc-text').textContent = Math.round(data.batt.soc) + "%";
        document.getElementById('detail-pv-volt').textContent = data.pvVolt.toFixed(1);
        document.getElementById('detail-temp').textContent = data.temp.toFixed(1);
        
        const offset = 282.7 - ((data.batt.soc/100) * 282.7);
        const ring = document.querySelector('.gauge-ring');
        if(ring) { ring.style.strokeDashoffset = offset; ring.style.stroke = data.batt.soc < 30 ? "#ef4444" : "#22c55e"; }

        if(liveChartInstance){
            livePVData.push(data.pv.power); livePVData.shift(); liveChartInstance.update('none');
        }

        // Cek selisih waktu sekarang vs waktu data terakhir (timestamp dari ESP32)
        const now = Date.now() / 1000; // Detik sekarang
        const dataTime = data.timestamp || 0; 
        const diff = now - dataTime;

        // Kalau data telat lebih dari 60 detik, anggap hang. 120 detik, set is_online ke false di database.
        if (diff > 120) {
            document.getElementById('device-status').textContent = "Device Offline";
            document.getElementById('device-status').className = "text-sm text-red-600 font-bold";
            document.getElementById('conn-dot-device').className = "inline-block w-2 h-2 rounded-full bg-red-500 animate-pulse";
            db.ref('epever/is_online').set(false)
                .catch((error) => console.error("Gagal update DB:", error));
        } else if (diff > 60) {
            document.getElementById('device-status').textContent = "Device Probably Offline";
            document.getElementById('device-status').className = "text-sm text-orange-600 font-bold";
            document.getElementById('conn-dot-device').className = "inline-block w-2 h-2 rounded-full bg-orange-500 animate-bounce";
        } else {
            document.getElementById('device-status').textContent = "Device Online";
            document.getElementById('device-status').className = "text-sm text-green-600 font-bold";
            document.getElementById('conn-dot-device').className = "inline-block w-2 h-2 rounded-full bg-green-500 animate-pulse";
            db.ref('epever/is_online').set(true)
                .catch((error) => console.error("Gagal update DB:", error));
        }
    }

    function initCharts() {
        const ctx = document.getElementById('liveChart');
        if(ctx) liveChartInstance = new Chart(ctx, { type: 'line', data: { labels: liveLabels, datasets: [{ label: 'PV (W)', data: livePVData, borderColor: '#0ea5e9', backgroundColor: '#0ea5e933', fill: true, tension: 0.4, pointRadius: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false} }, scales: { x: { display: false }, y: { beginAtZero: true } } } });
    }

    // --- Helper to Decode Epever Status Code ---
    // Extract Bits 3-2 for Charging Status
    function getStatusLabel(code) {
        if(code === undefined || code === null) return "-";
        const chgState = (code >> 2) & 0x03;
        const voltState = (code >> 14) & 0x03
        if(voltState===1)return{text:"OVP",color:"text-red-500"};
        if(code&0x8000)return{text:"Fault",color:"text-red-600"};;
        switch(chgState) {
            case 0: return{text:"Standby",color:"text-gray-400"};
            case 1: return{text:"Float",color:"text-solar-500"};
            case 2: return{text:"Boost",color:"text-orange-500"};
            case 3: return{text:"Equalize",color:"text-blue-500"};
            default: return{text:"Active",color:"text-green-500"};
        }
    }

    // --- DAY CHART INSTANCE MANAGEMENT ---
    function getDayChartInstance() {
        if (dayChartInstance) return dayChartInstance; // Already exists
        
        const ctxDay = document.getElementById('dayChart');
        if (!ctxDay) return null; // Element missing (should not happen)

        // Initialize only if element exists
        try {
            dayChartInstance = new Chart(ctxDay, { 
                type: 'bar', 
                data: { labels: [], datasets: [{ label: 'Power (W)', data: [], backgroundColor: '#f97316' }] }, 
                options: { responsive: true, maintainAspectRatio: false } 
            });
            return dayChartInstance;
        } catch (e) {
            console.error("Chart init failed:", e);
            return null;
        }
    }

    // --- HISTORY LOG FETCHING ---
    function fetchDayLog() {
        const dateInput = document.getElementById('logDateSelector').value;
        if(!dateInput) return alert("Select a date");

        const startTs = new Date(dateInput).getTime() / 1000;       // Start of selected day in seconds
        const endTs = startTs + 86400;                              // End of selected day in seconds

        const tbody = document.getElementById('detail-table-body');
        tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center">Loading...</td></tr>';

        db.ref('epever/history').orderByChild('hStamp').startAt(startTs).endAt(endTs).once('value')
        .then(snapshot => {
            const data = snapshot.val();
            fetchedLogData = []; 
            
            if(!data) {
                tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center">No data found for this date</td></tr>';
                return;
            }

            let html = '';
            let chartLabels = [];
            let chartData = [];

            const logs = Object.values(data).sort((a,b) => a.hStamp - b.hStamp);    // Sort descending by timestamp

            logs.forEach(log => {
                const dateObj = new Date(log.hStamp * 1000);    // Convert to milliseconds
                const timeStr = dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); // Format HH:MM
                const statusStr = getStatusLabel(log.hCCode); // Decode 'hCCode' from DB
                const statusStrEL = `<span class="px-2 py-1 rounded text-xs font-bold bg-gray-100 ${statusStr.color}">${statusStr.text}</span>`;
                fetchedLogData.push({ time: timeStr, ...log }); 

                html += `<tr class="hover:bg-gray-50 dark:hover:bg-slate-800">
                    <td class="px-6 py-4">${timeStr}</td>
                    <td class="px-6 py-4">${statusStrEL}</td>
                    <td class="px-6 py-4 text-right">${log.hPWatt} W</td>
                    <td class="px-6 py-4 text-right">${log.hBVolt} V</td>
                    <td class="px-6 py-4 text-right">${log.hBSOC}%</td>
                </tr>`;

                chartLabels.push(timeStr);
                chartData.push(log.hBVolt);
            });

            tbody.innerHTML = html;

            // --- FIXED CHART UPDATE LOGIC ---
            // Safely get or create the chart instance now that the view is active
            const chart = getDayChartInstance();
            if (chart) {
                chart.data.labels = chartLabels;
                chart.data.datasets[0].data = chartData;
                chart.update();
            } else {
                console.warn("Chart skipped: could not initialize canvas");
            }
        })
        .catch(err => {
            console.error(err);
            tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-500">Error: ${err.message}</td></tr>`;
        });
    }

    // --- DOWNLOAD LOG AS CSV ---
    function downloadLog() {
        if(fetchedLogData.length === 0) return alert("No data to download. Search for a date first.");
        
        let csvContent = "data:text/csv;charset=utf-8,Time,Status,Power(W),Battery(V),SOC(%)\n";
        fetchedLogData.forEach(row => {
            const stCode = getStatusLabel(row.hCCode); // Decode 'hCCode' from DB
            csvContent += `${row.time},${stCode},${row.hPWatt},${row.hBVolt},${row.hBSOC}\n`;
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "solar_log.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // --- FIRMWARE INFO FETCHING ---
    function fetchFirmwareInfo() {
        db.ref('/epever/firmware_info').once('value').then(snapshot => {
            const info = snapshot.val();
            if (!info) return alert("No firmware info available.");
            document.getElementById('fw-version').textContent = info.firmware_version || '--';
            document.getElementById('fw-date').textContent = info.firmware_date || '--';
            document.getElementById('fw-chip').textContent = info.chip_model || '--';
            document.getElementById('fw-free').textContent = info.free_space ? info.free_space + ' bytes' : '--';
        }).catch(e => alert("Error fetching firmware info: " + e.message));
    }

    // --- FIRMWARE UPLOAD LOGIC ---
    let selectedFile = null;
    function handleDrop(e) {
        e.preventDefault();
        e.stopPropagation();
        e.currentTarget.classList.remove('bg-gray-100');
        if (e.dataTransfer.files.length && e.dataTransfer.files[0].name.endsWith('.bin')) {
            selectedFile = e.dataTransfer.files[0];
            document.getElementById('fw-message').textContent = `Selected: ${selectedFile.name}`;
            document.getElementById('fw-message').className = 'text-xs text-center text-green-600 dark:text-green-400';
        } else {
            document.getElementById('fw-message').textContent = 'Please drop a .bin file';
            document.getElementById('fw-message').className = 'text-xs text-center text-red-600';
        }
    }

    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file && file.name.endsWith('.bin')) {
            selectedFile = file;
            document.getElementById('fw-message').textContent = `Selected: ${file.name}`;
            document.getElementById('fw-message').className = "text-xs text-center text-green-600 font-bold mt-2";
        } else {
            alert("Please select a .bin file!");
            selectedFile = null;
        }
    }

    function uploadFirmware() {
        if(!selectedFile) return alert("Select file first!");
        
        const btn = document.getElementById('fw-upload-btn');
        const statusDiv = document.getElementById('fw-upload-status');
        const statusText = document.getElementById('fw-status-text');
        const progressBar = document.getElementById('fw-progress-bar');
        
        btn.disabled = true;
        statusDiv.classList.remove('hidden');
        statusText.textContent = "Uploading to Cloud...";

        // 1. Upload ke Storage dengan nama "firmware.bin" (fixed name agar ESP32 mudah download)
        const storageRef = storage.ref('firmware.bin');
        const task = storageRef.put(selectedFile);

        task.on('state_changed', 
            (snapshot) => {
                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                progressBar.style.width = progress + "%";
            }, 
            (error) => {
                console.error(error);
                alert("Upload Failed: " + error.message);
                btn.disabled = false;
            }, 
            () => {
                // 2. Upload Sukses -> Trigger ESP32
                statusText.textContent = "Flashing Device...";
                progressBar.style.width = "100%";
                
                // Set flag di database
                db.ref('epever/firmware_info/ota_trigger').set(true)
                .then(() => {
                    alert("Success! Device will restart shortly.");
                    btn.disabled = false;
                    statusDiv.classList.add('hidden');
                    selectedFile = null;
                    document.getElementById('fw-message').textContent = "";
                })
                .catch(e => alert("DB Error: " + e.message));
            }
        );
    }
</script>
</body>
</html>